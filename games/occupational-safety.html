<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì—…ì•ˆì „ - ë³´í˜¸êµ¬ ë§¤ì¹­ | 7 ì•ˆì „ì¢Œì˜ ì£¼ì¸ì€ ëˆ„êµ¬ì¸ê°€</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/game.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <style>
        .matching-game {
            max-width: 700px;
            margin: 0 auto;
        }

        .scenario-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #795548 0%, #5D4037 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }

        .worker-icon {
            font-size: 5rem;
            margin-bottom: 10px;
        }

        .scenario-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .scenario-desc {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .equipment-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 2.5rem;
            padding: 10px;
        }

        .equipment-item:hover {
            border-color: var(--coin-gold);
            transform: scale(1.05);
        }

        .equipment-item.selected {
            border-color: var(--pipe-green);
            background: #e8f5e9;
            box-shadow: 0 0 15px rgba(0, 168, 0, 0.3);
        }

        .equipment-item.correct {
            border-color: #28a745;
            background: #d4edda;
            animation: pulse 0.5s;
        }

        .equipment-item.wrong {
            border-color: #dc3545;
            background: #f8d7da;
            animation: shake 0.5s;
        }

        .equipment-name {
            font-size: 0.75rem;
            margin-top: 5px;
            text-align: center;
            color: #666;
        }

        .selected-equipment {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 60px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .selected-item {
            background: var(--pipe-green);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .submit-section {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <header class="game-header">
            <div class="game-title-section">
                <button class="back-btn" onclick="location.href='../index.html'">â†</button>
                <h1 class="game-title"><span class="game-emoji">ğŸ‘·</span> ì§ì—…ì•ˆì „</h1>
            </div>
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-icon">ğŸ“‹</span>
                    <span class="stat-value" id="progress">1/4</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">âœ…</span>
                    <span class="stat-value" id="correct">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">â­</span>
                    <span class="stat-value" id="score">0</span>
                </div>
            </div>
        </header>

        <main class="game-content">
            <div class="game-board">
                <div class="game-board-header">
                    <h2 class="game-board-title">ğŸ‘· ì•Œë§ì€ ë³´í˜¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”!</h2>
                </div>
                <div class="game-board-content">
                    <div class="start-screen" id="startScreen">
                        <div class="start-emoji">ğŸ‘·</div>
                        <h2 class="start-title">ë³´í˜¸êµ¬ ë§¤ì¹­ ê²Œì„</h2>
                        <p class="start-description">
                            ê° ì‘ì—… ìƒí™©ì— ë§ëŠ” ì•ˆì „ ë³´í˜¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”!<br>
                            ì˜¬ë°”ë¥¸ ë³´í˜¸êµ¬ë¡œ ì‘ì—…ìë¥¼ ë³´í˜¸í•´ì£¼ì„¸ìš”!
                        </p>
                        <button class="start-btn" id="startBtn">ê²Œì„ ì‹œì‘!</button>
                    </div>

                    <div class="matching-game hidden" id="gameArea">
                        <div class="scenario-display" id="scenarioDisplay">
                            <div class="worker-icon" id="workerIcon">ğŸ‘·</div>
                            <div class="scenario-title" id="scenarioTitle"></div>
                            <div class="scenario-desc" id="scenarioDesc"></div>
                        </div>

                        <div class="equipment-grid" id="equipmentGrid"></div>

                        <div class="selected-equipment" id="selectedEquipment">
                            <span style="color:#999;">ì„ íƒí•œ ë³´í˜¸êµ¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span>
                        </div>

                        <div class="submit-section">
                            <button class="btn btn-primary btn-pixel" id="submitBtn">ì œì¶œí•˜ê¸°</button>
                        </div>

                        <div id="feedback" style="margin-top:20px; text-align:center;"></div>
                    </div>

                    <div class="game-over-screen" id="gameOverScreen">
                        <h2 class="game-over-title" id="resultTitle">ê²Œì„ ì¢…ë£Œ!</h2>
                        <p class="game-over-score" id="resultScore"></p>
                        <div class="game-over-stars" id="resultStars"></div>
                        <div class="game-over-buttons">
                            <button class="btn btn-primary btn-pixel" onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
                            <button class="btn btn-gold btn-pixel" onclick="location.href='../index.html'">ëŒì•„ê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/survey.js"></script>
    <script>
        const allEquipment = [
            { id: 'helmet', emoji: 'â›‘ï¸', name: 'ì•ˆì „ëª¨' },
            { id: 'goggles', emoji: 'ğŸ¥½', name: 'ë³´ì•ˆê²½' },
            { id: 'mask', emoji: 'ğŸ˜·', name: 'ë°©ì§„ë§ˆìŠ¤í¬' },
            { id: 'gloves', emoji: 'ğŸ§¤', name: 'ì•ˆì „ì¥ê°‘' },
            { id: 'boots', emoji: 'ğŸ¥¾', name: 'ì•ˆì „í™”' },
            { id: 'vest', emoji: 'ğŸ¦º', name: 'ì•ˆì „ì¡°ë¼' },
            { id: 'earmuffs', emoji: 'ğŸ§', name: 'ê·€ë§ˆê°œ' },
            { id: 'welding', emoji: 'ğŸ”²', name: 'ìš©ì ‘ë§ˆìŠ¤í¬' }
        ];

        const scenarios = [
            {
                icon: 'ğŸ”¨',
                title: 'ê±´ì„¤ í˜„ì¥ ì‘ì—…',
                desc: 'ë†’ì€ ê³³ì—ì„œ ê±´ì„¤ ì‘ì—…ì„ í•©ë‹ˆë‹¤. ë¬´ê±°ìš´ ë¬¼ê±´ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”.',
                required: ['helmet', 'boots', 'vest', 'gloves'],
                explanation: 'ê±´ì„¤ í˜„ì¥ì—ì„œëŠ” ì•ˆì „ëª¨(ë‚™í•˜ë¬¼), ì•ˆì „í™”(ëª», ë¬´ê±°ìš´ ë¬¼ê±´), ì•ˆì „ì¡°ë¼(ê°€ì‹œì„±), ì¥ê°‘(ì† ë³´í˜¸)ì´ í•„ìˆ˜ì˜ˆìš”!'
            },
            {
                icon: 'âš¡',
                title: 'ìš©ì ‘ ì‘ì—…',
                desc: 'ê¸ˆì†ì„ ìš©ì ‘í•©ë‹ˆë‹¤. ê°•í•œ ë¹›ê³¼ ë¶ˆê½ƒì´ íŠ‘ë‹ˆë‹¤.',
                required: ['welding', 'gloves', 'boots'],
                explanation: 'ìš©ì ‘ ì‹œ ìš©ì ‘ë§ˆìŠ¤í¬(ëˆˆ ë³´í˜¸), ê°€ì£½ì¥ê°‘(í™”ìƒ ë°©ì§€), ì•ˆì „í™”(ë¶ˆê½ƒ ë°©ì§€)ê°€ í•„ìˆ˜ì˜ˆìš”!'
            },
            {
                icon: 'ğŸ§ª',
                title: 'í™”í•™ë¬¼ì§ˆ ì·¨ê¸‰',
                desc: 'ì‹¤í—˜ì‹¤ì—ì„œ í™”í•™ì•½í’ˆì„ ë‹¤ë£¹ë‹ˆë‹¤. ìœ í•´ ì¦ê¸°ê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ìš”.',
                required: ['goggles', 'gloves', 'mask'],
                explanation: 'í™”í•™ë¬¼ì§ˆ ì‘ì—… ì‹œ ë³´ì•ˆê²½(ëˆˆ ë³´í˜¸), ë‚´í™”í•™ ì¥ê°‘, ë°©ë…ë§ˆìŠ¤í¬(ìœ í•´ê°€ìŠ¤)ê°€ í•„ìˆ˜ì˜ˆìš”!'
            },
            {
                icon: 'ğŸ”Š',
                title: 'ì†ŒìŒ í˜„ì¥ ì‘ì—…',
                desc: 'í° ê¸°ê³„ê°€ ëŒì•„ê°€ëŠ” ê³µì¥ì—ì„œ ì¼í•©ë‹ˆë‹¤. ì†ŒìŒì´ ë§¤ìš° í½ë‹ˆë‹¤.',
                required: ['helmet', 'earmuffs', 'boots'],
                explanation: 'ì†ŒìŒ í˜„ì¥ì—ì„œëŠ” ê·€ë§ˆê°œ(ì²­ë ¥ ë³´í˜¸), ì•ˆì „ëª¨, ì•ˆì „í™”ê°€ í•„ìˆ˜ì˜ˆìš”! 85dB ì´ìƒì€ ì²­ë ¥ ì†ìƒ ìœ„í—˜!'
            }
        ];

        const state = {
            current: 0,
            selected: [],
            correct: 0,
            score: 0
        };

        const el = {
            startScreen: document.getElementById('startScreen'),
            gameArea: document.getElementById('gameArea'),
            workerIcon: document.getElementById('workerIcon'),
            scenarioTitle: document.getElementById('scenarioTitle'),
            scenarioDesc: document.getElementById('scenarioDesc'),
            equipmentGrid: document.getElementById('equipmentGrid'),
            selectedEquipment: document.getElementById('selectedEquipment'),
            submitBtn: document.getElementById('submitBtn'),
            feedback: document.getElementById('feedback'),
            progress: document.getElementById('progress'),
            correct: document.getElementById('correct'),
            score: document.getElementById('score'),
            gameOverScreen: document.getElementById('gameOverScreen'),
            resultTitle: document.getElementById('resultTitle'),
            resultScore: document.getElementById('resultScore'),
            resultStars: document.getElementById('resultStars')
        };

        // Initialize Chatbot immediately so it's visible on start screen
        const chatbot = new Chatbot('occupational_safety');

        document.getElementById('startBtn').addEventListener('click', startGame);
        el.submitBtn.addEventListener('click', checkAnswer);

        function startGame() {
            el.startScreen.classList.add('hidden');
            el.gameArea.classList.remove('hidden');
            showScenario();
        }

        function showScenario() {
            const s = scenarios[state.current];
            state.selected = [];

            el.workerIcon.textContent = s.icon;
            el.scenarioTitle.textContent = s.title;
            el.scenarioDesc.textContent = s.desc;
            el.feedback.innerHTML = '';
            el.submitBtn.disabled = false;

            renderEquipment();
            updateSelectedDisplay();
            updateUI();
        }

        function renderEquipment() {
            el.equipmentGrid.innerHTML = '';

            allEquipment.forEach(eq => {
                const item = document.createElement('div');
                item.className = 'equipment-item';
                item.dataset.id = eq.id;
                item.innerHTML = `${eq.emoji}<span class="equipment-name">${eq.name}</span>`;
                item.addEventListener('click', () => toggleEquipment(eq));
                el.equipmentGrid.appendChild(item);
            });
        }

        function toggleEquipment(eq) {
            const index = state.selected.findIndex(s => s.id === eq.id);
            if (index >= 0) {
                state.selected.splice(index, 1);
            } else {
                state.selected.push(eq);
            }

            document.querySelectorAll('.equipment-item').forEach(item => {
                item.classList.toggle('selected', state.selected.some(s => s.id === item.dataset.id));
            });

            updateSelectedDisplay();
        }

        function updateSelectedDisplay() {
            if (state.selected.length === 0) {
                el.selectedEquipment.innerHTML = '<span style="color:#999;">ì„ íƒí•œ ë³´í˜¸êµ¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</span>';
            } else {
                el.selectedEquipment.innerHTML = state.selected.map(eq => `
          <div class="selected-item">
            ${eq.emoji} ${eq.name}
            <button class="remove-btn" onclick="removeEquipment('${eq.id}')">âœ•</button>
          </div>
        `).join('');
            }
        }

        window.removeEquipment = function (id) {
            state.selected = state.selected.filter(s => s.id !== id);
            document.querySelectorAll('.equipment-item').forEach(item => {
                item.classList.toggle('selected', state.selected.some(s => s.id === item.dataset.id));
            });
            updateSelectedDisplay();
        };

        function checkAnswer() {
            const s = scenarios[state.current];
            const selectedIds = state.selected.map(eq => eq.id).sort();
            const requiredIds = s.required.sort();

            const isCorrect = selectedIds.length === requiredIds.length &&
                selectedIds.every((id, i) => id === requiredIds[i]);

            el.submitBtn.disabled = true;

            // Highlight correct/wrong
            document.querySelectorAll('.equipment-item').forEach(item => {
                const id = item.dataset.id;
                const isRequired = s.required.includes(id);
                const isSelected = selectedIds.includes(id);

                if (isRequired) item.classList.add('correct');
                if (isSelected && !isRequired) item.classList.add('wrong');
            });

            if (isCorrect) {
                state.correct++;
                state.score += 250;
                el.feedback.innerHTML = `<div style="color:#28a745; font-weight:bold;">âœ… ì •ë‹µ! ${s.explanation}</div>`;
            } else {
                el.feedback.innerHTML = `<div style="color:#dc3545; font-weight:bold;">âŒ ì•„ì‰¬ì›Œìš”! ${s.explanation}</div>`;
            }

            updateUI();

            setTimeout(() => {
                state.current++;
                if (state.current < scenarios.length) {
                    showScenario();
                } else {
                    endGame();
                }
            }, 3000);
        }

        function updateUI() {
            el.progress.textContent = `${state.current + 1}/${scenarios.length}`;
            el.correct.textContent = state.correct;
            el.score.textContent = state.score;
        }

        function endGame() {
            const stars = state.correct >= 4 ? 3 : 0;

            el.resultTitle.textContent = stars >= 2 ? 'ğŸ‰ ì•ˆì „ ì „ë¬¸ê°€!' : 'ğŸ’ª ë” ì—°ìŠµí•´ë´ìš”!';
            el.resultTitle.style.color = stars >= 2 ? '#2ECC71' : '#FCBC00';
            el.resultScore.textContent = `ì •ë‹µ: ${state.correct}/${scenarios.length} | ì ìˆ˜: ${state.score}ì `;
            el.resultStars.textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);

            el.gameOverScreen.classList.add('active');

            if (typeof ProgressManager !== 'undefined') {
                ProgressManager.completeGame('occupational_safety', stars);
            }

            setTimeout(() => {
                new SurveyModal('occupational_safety', 'ì§ì—…ì•ˆì „', () => { });
                document.querySelector('.modal-overlay').classList.add('active');
            }, 1500);
        }
    </script>
</body>

</html>