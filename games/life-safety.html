<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí™œì•ˆì „ - ìœ„í—˜ìš”ì†Œ ì°¾ê¸° | 7 ì•ˆì „ì¢Œì˜ ì£¼ì¸ì€ ëˆ„êµ¬ì¸ê°€</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/game.css">
    <link rel="stylesheet" href="../css/chatbot.css">
    <style>
        /* Specific override for Life Safety Chatbot Orientation */
        #chatbotCharacter .character-image {
            transform: scaleX(1) !important;
            /* Flip to face Right (or away from center depending on base) */
        }

        #chatbotCharacter:hover .character-image {
            transform: translateY(-5px) scaleX(1) !important;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <header class="game-header">
            <div class="game-title-section">
                <button class="back-btn" onclick="location.href='../index.html'">â†</button>
                <h1 class="game-title"><span class="game-emoji">ğŸ </span> ìƒí™œì•ˆì „</h1>
            </div>
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-icon">â±ï¸</span>
                    <span class="stat-value" id="timer">60</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸ¯</span>
                    <span class="stat-value" id="found">0/6</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">â­</span>
                    <span class="stat-value" id="score">0</span>
                </div>
            </div>
        </header>

        <main class="game-content">
            <div class="game-board">
                <div class="game-board-header">
                    <h2 class="game-board-title">ğŸ” ë°© ì•ˆì˜ ìœ„í—˜ ìš”ì†Œë¥¼ ì°¾ì•„ë¼!</h2>
                </div>
                <div class="game-board-content">
                    <!-- Start Screen -->
                    <div class="start-screen" id="startScreen">
                        <div class="start-emoji">ğŸ </div>
                        <h2 class="start-title">ìœ„í—˜ìš”ì†Œ ì°¾ê¸°</h2>
                        <p class="start-description">
                            ì§‘ ì•ˆì— ìˆ¨ì–´ìˆëŠ” 6ê°€ì§€ ìœ„í—˜ ìš”ì†Œë¥¼ ì°¾ì•„ í´ë¦­í•˜ì„¸ìš”!<br>
                            ì œí•œ ì‹œê°„ 60ì´ˆ ì•ˆì— ëª¨ë‘ ì°¾ìœ¼ë©´ ìŠ¹ë¦¬!
                        </p>
                        <button class="start-btn" id="startBtn">ê²Œì„ ì‹œì‘!</button>
                    </div>

                    <!-- Game Area -->
                    <div class="find-items-container hidden" id="gameArea">
                        <div class="find-items-scene" id="scene"
                            style="background: linear-gradient(180deg, #FFF8E7 0%, #FFE4B5 100%);">
                            <!-- Room elements will be drawn here -->
                        </div>
                        <p class="items-found-counter">
                            ì°¾ì€ ìœ„í—˜ ìš”ì†Œ: <span id="foundCount">0</span> / 6
                        </p>
                    </div>

                    <!-- Game Over Screen -->
                    <div class="game-over-screen" id="gameOverScreen">
                        <h2 class="game-over-title" id="resultTitle">ê²Œì„ ì¢…ë£Œ!</h2>
                        <p class="game-over-score" id="resultScore"></p>
                        <div class="game-over-stars" id="resultStars"></div>
                        <div class="game-over-buttons">
                            <button class="btn btn-primary btn-pixel" onclick="location.reload()">ë‹¤ì‹œí•˜ê¸°</button>
                            <button class="btn btn-gold btn-pixel" onclick="location.href='../index.html'">ëŒì•„ê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/survey.js"></script>
    <script>
        // Game State
        const gameState = {
            isPlaying: false,
            timeLeft: 60,
            foundItems: [],
            score: 0,
            timerInterval: null
        };

        // Danger items with positions (percentage-based) - matched to new background image
        const dangerItems = [
            { id: 1, name: 'ì½˜ì„¼íŠ¸ ê³¼ë¶€í•˜', x: 8, y: 82, hint: 'ì „ê¸° ì½˜ì„¼íŠ¸ê°€ ê²€ê²Œ ê·¸ì„ë ¤ ìˆì–´ìš”!' },
            { id: 2, name: 'ë¯¸ë„ëŸ¬ìš´ ë°”ë‹¥', x: 65, y: 90, hint: 'ë°”ë‹¥ì— ë¬¼ì´ ê³ ì—¬ ìˆì–´ ë¯¸ë„ëŸ¬ì›Œìš”!' },
            { id: 3, name: 'ë‚ ì¹´ë¡œìš´ ì¹¼', x: 92, y: 68, hint: 'ì¹¼ì´ ìœ„í—˜í•˜ê²Œ ì„¸ì›Œì ¸ ìˆì–´ìš”!' },
            { id: 4, name: 'ê¹¨ì§„ ì°½ë¬¸', x: 88, y: 25, hint: 'ìœ ë¦¬ì°½ì´ ê¹¨ì ¸ ìˆì–´ ìœ„í—˜í•´ìš”!' },
            { id: 5, name: 'ì£¼ë°© í™”ì¬', x: 12, y: 55, hint: 'í”„ë¼ì´íŒ¬ì—ì„œ ë¶ˆì´ ì†Ÿì•„ì˜¤ë¥´ê³  ìˆì–´ìš”!' },
            { id: 6, name: 'ê³„ë‹¨ ì¥ì• ë¬¼', x: 50, y: 65, hint: 'ê³„ë‹¨ì— ê³°ì¸í˜•ì´ ë†“ì—¬ ìˆì–´ ê±¸ë ¤ ë„˜ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”!' }
        ];

        // DOM Elements
        const elements = {
            startScreen: document.getElementById('startScreen'),
            startBtn: document.getElementById('startBtn'),
            gameArea: document.getElementById('gameArea'),
            scene: document.getElementById('scene'),
            timer: document.getElementById('timer'),
            found: document.getElementById('found'),
            score: document.getElementById('score'),
            foundCount: document.getElementById('foundCount'),
            gameOverScreen: document.getElementById('gameOverScreen'),
            resultTitle: document.getElementById('resultTitle'),
            resultScore: document.getElementById('resultScore'),
            resultStars: document.getElementById('resultStars')
        };

        // Initialize game
        function init() {
            elements.startBtn.addEventListener('click', startGame);
            new Chatbot('life_safety');
        }

        // Start game
        function startGame() {
            gameState.isPlaying = true;
            gameState.timeLeft = 60;
            gameState.foundItems = [];
            gameState.score = 0;

            elements.startScreen.classList.add('hidden');
            elements.gameArea.classList.remove('hidden');

            createRoom();
            createHotspots();
            startTimer();
        }

        // Create room visual
        function createRoom() {
            elements.scene.innerHTML = `
                <div style="position: absolute; width: 100%; height: 100%; pointer-events: none;">
                    <img src="../images/life_safety_bg.png" alt="Life Safety Room" style="width: 100%; height: 100%; object-fit: fill;">
                </div>
            `;
        }

        // Create clickable hotspots
        function createHotspots() {
            dangerItems.forEach(item => {
                const hotspot = document.createElement('div');
                hotspot.className = 'find-item-hotspot';
                hotspot.style.left = `${item.x}%`;
                hotspot.style.top = `${item.y}%`;
                hotspot.dataset.id = item.id;
                hotspot.title = item.hint;

                hotspot.addEventListener('click', () => handleItemClick(item, hotspot));
                elements.scene.appendChild(hotspot);
            });
        }

        // Handle item click
        function handleItemClick(item, hotspot) {
            if (gameState.foundItems.includes(item.id)) return;

            gameState.foundItems.push(item.id);
            gameState.score += 100 + Math.floor(gameState.timeLeft * 2);

            hotspot.classList.add('found');
            hotspot.innerHTML = `<span style="font-size: 1.5rem;">âœ“</span>`;

            updateUI();
            showFeedback(item.name, true);

            if (gameState.foundItems.length === dangerItems.length) {
                endGame(true);
            }
        }

        // Show feedback
        function showFeedback(text, success) {
            const feedback = document.createElement('div');
            feedback.className = `feedback-message ${success ? 'success' : 'error'}`;
            feedback.textContent = success ? `âœ“ ${text} ë°œê²¬!` : text;
            document.body.appendChild(feedback);

            setTimeout(() => feedback.remove(), 1500);
        }

        // Update UI
        function updateUI() {
            elements.found.textContent = `${gameState.foundItems.length}/${dangerItems.length}`;
            elements.foundCount.textContent = gameState.foundItems.length;
            elements.score.textContent = gameState.score;
        }

        // Timer
        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                elements.timer.textContent = gameState.timeLeft;

                if (gameState.timeLeft <= 10) {
                    elements.timer.style.color = '#ff4444';
                }

                if (gameState.timeLeft <= 0) {
                    endGame(false);
                }
            }, 1000);
        }

        // End game
        function endGame(won) {
            gameState.isPlaying = false;
            clearInterval(gameState.timerInterval);

            const stars = won ? 3 : 0;

            elements.resultTitle.textContent = won ? 'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!' : 'â° ì‹œê°„ ì¢…ë£Œ!';
            elements.resultTitle.style.color = won ? '#2ECC71' : '#FCBC00';
            elements.resultScore.textContent = `ì ìˆ˜: ${gameState.score}ì  | ì°¾ì€ ìœ„í—˜ìš”ì†Œ: ${gameState.foundItems.length}/${dangerItems.length}`;
            elements.resultStars.textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);

            elements.gameOverScreen.classList.add('active');

            // Save progress
            if (typeof ProgressManager !== 'undefined') {
                ProgressManager.completeGame('life_safety', stars);
            }

            // Show survey
            setTimeout(() => {
                new SurveyModal('life_safety', 'ìƒí™œì•ˆì „', () => { });
                document.querySelector('.modal-overlay').classList.add('active');
            }, 1500);
        }

        // Initialize
        init();
    </script>
</body>

</html>